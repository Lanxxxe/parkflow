<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./AdminLiveMap.css" />
    <title>ParkFlow Dashboard</title>
  </head>

  <body>
    <div class="top-bar">
      <div class="logo-container">
        <img src="./assets/car-logo.png" class="car-logo" />
        <span class="title">PARKFLOW</span>
      </div>

      <div class="center-title">Live Map (Admin)</div>

      <div class="nav-buttons">
        <a href="dashboard.html" class="nav-btn">Dashboard</a>
        <a href="index.html" class="nav-btn">Logout</a>
        <a href="backlog.html" class="nav-btn">Backlog</a>
      </div>
    </div>

    <div class="map-container">
      <img src="./assets/parking_lot.png" alt="Parking Lot" class="parking-lot" />
      
      <div class="parking-grid" id="admin-parking-grid">
          <div class="park-slot available" id="slot-1" data-slot-name="A1" onclick="selectSlot(1)">
              <img src="./assets/car.png" class="car-on-slot" alt="Car" style="display: none;">
              <p class="slot-name">A1</p>
          </div>
          <div class="park-slot available" id="slot-2" data-slot-name="A2" onclick="selectSlot(2)">
              <img src="./assets/car.png" class="car-on-slot" alt="Car" style="display: none;">
              <p class="slot-name">A2</p>
          </div>
          <div class="park-slot available" id="slot-3" data-slot-name="A3" onclick="selectSlot(3)">
              <img src="./assets/car.png" class="car-on-slot" alt="Car" style="display: none;">
              <p class="slot-name">A3</p>
          </div>
          <div class="park-slot available" id="slot-4" data-slot-name="A4" onclick="selectSlot(4)">
              <img src="./assets/car.png" class="car-on-slot" alt="Car" style="display: none;">
              <p class="slot-name">A4</p>
          </div>
          <div class="park-slot available" id="slot-5" data-slot-name="A5" onclick="selectSlot(5)">
              <img src="./assets/car.png" class="car-on-slot" alt="Car" style="display: none;">
              <p class="slot-name">A5</p>
          </div>
          <div class="park-slot available" id="slot-6" data-slot-name="A6" onclick="selectSlot(6)">
              <img src="./assets/car.png" class="car-on-slot" alt="Car" style="display: none;">
              <p class="slot-name">A6</p>
          </div>
          <div class="park-slot available" id="slot-7" data-slot-name="A7" onclick="selectSlot(7)">
              <img src="./assets/car.png" class="car-on-slot" alt="Car" style="display: none;">
              <p class="slot-name">A7</p>
          </div>
          <div class="park-slot available" id="slot-8" data-slot-name="A8" onclick="selectSlot(8)">
              <img src="./assets/car.png" class="car-on-slot" alt="Car" style="display: none;">
              <p class="slot-name">A8</p>
          </div>
          <div class="park-slot available" id="slot-9" data-slot-name="A9" onclick="selectSlot(9)">
              <img src="./assets/car.png" class="car-on-slot" alt="Car" style="display: none;">
              <p class="slot-name">A9</p>
          </div>
          <div class="park-slot available" id="slot-10" data-slot-name="A10" onclick="selectSlot(10)">
              <img src="./assets/car.png" class="car-on-slot" alt="Car" style="display: none;">
              <p class="slot-name">A10</p>
      </div>
    </div>

    <div id="transaction-details" style="display: none;">
        <div id="dashboard-info">Transaction Summary</div>
        <div id="receipt-display">Status/Action buttons here.</div>
        <button id="confirm-btn" onclick="confirmSlotTaken(currentlySelectedSlotId)">Confirm Slot Taken</button>
        <button id="remove-btn" onclick="removeCar(currentlySelectedSlotId)" style="display:none; background-color: #e76f51;">Remove Car</button>
    </div>

    <script src="./js/config.js"></script>
    
    <script>
        let currentlySelectedSlotId = null;
        const totalSlots = 10;
        const slotPrefix = 'A';

        async function getSlotStates() {
            try {
                const response = await fetchData('parkingSlots', 'GET');
                
                return response.parking_slots;
                
            } catch (error) {
                console.error('Error fetching slot states from API:', error);
            }
            
        }

        async function loadMap() {
            const states = await getSlotStates();
            console.log('Loading map with states:', states);
            for (let i = 1; i <= totalSlots; i++) {
                const slotNumber = `${slotPrefix}${i}`;
                const state = states.find(s => s.slot_number === slotNumber);
                if (!state) {
                    console.error(`Slot ${slotNumber} not found in API response`);
                    continue;
                }
                console.log(`Slot ${i} state: ${state.status}`);
                const slotElement = document.getElementById(`slot-${i}`);
                if (slotElement) {
                    slotElement.className = `park-slot ${state.status}`;
                    const carLogo = slotElement.querySelector('.car-on-slot');
                    console.log(`Slot ${i} car display:`, state.status ? 'block' : 'none');
                    carLogo.style.display = state.status === 'taken' ? 'block' : 'none';
                }
            }
        }

        function selectSlot(slotId) {
            console.log(`Slot ${slotId} selected.`);
            const slotElement = document.getElementById(`slot-${slotId}`);
            const transactionDetails = document.getElementById('transaction-details');
            const confirmBtn = document.getElementById('confirm-btn');
            const removeBtn = document.getElementById('remove-btn');
            const slotName = slotElement.getAttribute('data-slot-name');

            if (currentlySelectedSlotId !== null && currentlySelectedSlotId !== slotId) {
                const prevSlot = document.getElementById(`slot-${currentlySelectedSlotId}`);
                if (prevSlot && !prevSlot.classList.contains('taken')) {
                    prevSlot.classList.remove('selected');
                    prevSlot.classList.add('available');
                }
            }
            
            if (currentlySelectedSlotId === slotId) {
                if (!slotElement.classList.contains('taken')) {
                    slotElement.classList.remove('selected');
                    slotElement.classList.add('available');
                }
                currentlySelectedSlotId = null;
                transactionDetails.style.display = 'none'; 
            } else {
                if (!slotElement.classList.contains('taken')) {
                    slotElement.classList.remove('available');
                    slotElement.classList.add('selected');
                }

                currentlySelectedSlotId = slotId;

                document.getElementById('dashboard-info').textContent = `Manage Slot ${slotName}`;
                
                if (slotElement.classList.contains('taken')) {
                    document.getElementById('receipt-display').textContent = `Slot ${slotName} is currently OCCUPIED.`;
                    confirmBtn.style.display = 'none';
                    removeBtn.style.display = 'block'; 
                } else {
                    document.getElementById('receipt-display').textContent = `Slot ${slotName} is available. Click 'Confirm' to occupy.`;
                    confirmBtn.style.display = 'block';
                    removeBtn.style.display = 'none';
                }
                transactionDetails.style.display = 'block'; 
            }
        }

        async function updateSlotState(slotId, status) {
            try {
                await fetchData(`/updateSlotStatus`, 'PUT', {   slot_number : `A${slotId}`, status: status});
                console.log(`Slot A${slotId} updated to ${status}`);
            } catch (error) {
                console.error('Error updating slot state via API:', error);
            }

            loadMap();
        }

        async function confirmSlotTaken(slotId) {
            if (slotId === null) return;
            const slotElement = document.getElementById(`slot-${slotId}`);

            if (!slotElement.classList.contains('taken')) {
                await updateSlotState(slotId, 'taken');
                
                selectSlot(slotId); 
                console.log(`Slot ${slotPrefix}${slotId} successfully taken.`);
            }
        }
        
        async function removeCar(slotId) {
            if (slotId === null) return;
            
            await updateSlotState(slotId, 'available');

            document.getElementById('transaction-details').style.display = 'none';
            currentlySelectedSlotId = null;
            
            console.log(`Car successfully removed from Slot ${slotPrefix}${slotId}. Slot is now available.`);
        }

        document.addEventListener("DOMContentLoaded", loadMap);
    </script>
  </body>
</html>